# 需求文档：Obsidian 交互式 HTML 表格插件

## 1. 需求背景

在 Obsidian 笔记应用中，现有表格功能（如 Markdown 表格或插件支持的公式计算）无法满足动态交互需求。用户希望嵌入一个可交互的 HTML 页面，包含可编辑表格，支持实时输入和计算（如金额汇总），并将输入数据自动转换为 Markdown 表格保存到当前笔记中。这种方法结合 HTML 的交互性与 Obsidian 的数据保存功能，提升笔记管理效率。

## 2. 功能目标

- **嵌入 HTML 页面**：在 Obsidian 笔记中嵌入一个交互式 HTML 页面，包含表格。
- **交互式表格**：
    - 用户可在 HTML 表格中输入数据（例如“项目”、“金额”、“描述”）。
    - 实时计算“金额”列总和，显示在“汇总”行。
- **数据转换与保存**：
    - 将 HTML 表格中的用户输入数据提取。
    - 自动转换为 Markdown 表格格式，插入到当前笔记中。
    - 确保数据与 HTML 表格对应，保存在笔记的 `.md` 文件中，支持 Obsidian Sync 同步。

## 3. 技术实现

### 3.1 技术选择

- **嵌入方式**：使用 `<iframe>` 标签嵌入 HTML 页面。
- **交互逻辑**：在 HTML 中使用 JavaScript 实现表格编辑和数据发送（通过 `postMessage`）。
- **插件支持**：开发 Obsidian 自定义插件，监听 HTML 数据并更新笔记。
- **依赖插件**：需要 **HTML Reader** 插件支持本地 HTML 文件嵌入。

### 3.2 实现步骤

#### 3.2.1 创建 HTML 页面

- **文件**：`table-input.html`，放置于 Vault 中。
- **内容**：
    - 包含一个表格（`id="dataTable"`），支持输入“项目”、“金额”、“描述”。
    - 实时计算“金额”总和，显示在“汇总”行。
    - 提供“保存到笔记”按钮，通过 `postMessage` 发送数据。
- **示例代码**：
    
    ```html
    <!DOCTYPE html>
    <html lang="zh">
    <head>
      <meta charset="UTF-8">
      <title>Interactive Table</title>
      <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        input { width: 100%; box-sizing: border-box; }
      </style>
    </head>
    <body>
      <table id="dataTable">
        <thead><tr><th>项目</th><th>金额</th><th>描述</th></tr></thead>
        <tbody><tr><td><input type="text" value="1"></td><td><input type="number" value="1"></td><td><input type="text"></td></tr><tr><td><input type="text" value="12"></td><td><input type="number" value="25"></td><td><input type="text"></td></tr></tbody>
        <tfoot><tr><td>汇总</td><td id="total">0</td><td>总计</td></tr></tfoot>
      </table>
      <button onclick="sendData()">保存到笔记</button>
      <script>
        function updateTotal() {
          const rows = document.querySelectorAll('#dataTable tbody tr');
          let total = 0;
          rows.forEach(row => { const amount = parseFloat(row.querySelector('input[type="number"]').value) || 0; total += amount; });
          document.getElementById('total').textContent = total;
        }
        document.querySelectorAll('#dataTable input').forEach(input => input.addEventListener('input', updateTotal));
        function sendData() {
          const rows = document.querySelectorAll('#dataTable tbody tr');
          const data = Array.from(rows).map(row => {
            const cells = row.querySelectorAll('input');
            return { project: cells[0].value, amount: cells[1].value, description: cells[2].value };
          });
          window.parent.postMessage({ type: 'tableData', data }, '*');
        }
        updateTotal();
      </script>
    </body>
    </html>
    ```
    

#### 3.2.2 嵌入 HTML

- 在笔记中添加：
    
    ```markdown
    <iframe src="table-input.html" width="100%" height="400px"></iframe>
    ```
    
- 安装 **HTML Reader** 插件以支持嵌入。

#### 3.2.3 开发 Obsidian 插件

- **文件结构**：`plugins/auto-sum-table/main.ts` 和 `manifest.json`。
- **插件代码**：
    
    ```typescript
    import { Plugin, Notice } from 'obsidian';
    
    export default class AutoSumTablePlugin extends Plugin {
      async onload() {
        window.addEventListener('message', (event) => {
          if (event.data.type === 'tableData') {
            this.updateTable(event.data.data);
          }
        });
        this.registerEvent(this.app.workspace.on('editor-change', (editor, info) => {
          const currentFile = this.app.workspace.getActiveFile();
          if (!currentFile || !currentFile.path.endsWith('.md')) return;
        }));
      }
    
      updateTable(data: { project: string; amount: string; description: string }[]) {
        const editor = this.app.workspace.getActiveViewOfType('markdown')?.editor;
        if (!editor) return;
    
        const content = editor.getValue();
        const lines = content.split('\n');
        let tableStart = -1, tableEnd = -1;
    
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes('<iframe src="table-input.html"')) {
            tableStart = i;
            tableEnd = i + 1;
            break;
          }
        }
    
        if (tableStart === -1) return;
    
        let markdownTable = '| 项目 | 金额 | 描述 |\n|------|------|------|';
        data.forEach(row => {
          markdownTable += `\n| ${row.project} | ${row.amount} | ${row.description} |`;
        });
        const total = data.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        markdownTable += `\n| 汇总 | ${total} | 总计 |`;
    
        const newContent = [
          ...lines.slice(0, tableEnd),
          markdownTable,
          ...lines.slice(tableEnd)
        ].join('\n');
    
        editor.setValue(newContent);
        new Notice(`表格已更新，金额汇总为: ${total}`);
      }
    
      onunload() {}
    }
    ```
    
- **manifest.json**：
    
    ```json
    {
      "id": "auto-sum-table",
      "name": "Auto Sum Table",
      "version": "1.0.0",
      "minAppVersion": "0.15.0",
      "description": "Converts HTML table data to Markdown table and saves to note.",
      "author": "Your Name",
      "authorUrl": "",
      "isDesktopOnly": false
    }
    ```
    
- **编译与安装**：使用 `npx tsc` 编译，放入插件文件夹，启用。

#### 3.2.4 使用流程

- **准备**：放置 `table-input.html`，在笔记中嵌入 iframe。
- **输入数据**：编辑 HTML 表格，实时查看汇总。
- **保存**：点击“保存到笔记”按钮，数据转换为 Markdown 表格，保存在笔记中。

### 3.3 优化与注意事项

- **实时更新**：当前需手动保存，可通过 `setInterval` 或 MutationObserver 实现实时性。
- **安全性**：`postMessage` 使用 `' * '` 存在风险，建议限制域（需测试 Obsidian 环境支持）。
- **样式**：在 `.obsidian/snippets/custom.css` 添加样式，启用 CSS。
- **错误处理**：验证“金额”列为数值。
- **多表格**：扩展插件支持多个 iframe。

### 4. 预期输出

- **示例输出**：
    
    ```markdown
    <iframe src="table-input.html" width="100%" height="400px"></iframe>
    | 项目 | 金额 | 描述 |
    |------|------|------|
    | 1    | 1    |      |
    | 12   | 25   |      |
    | 3    | 10   | test |
    | 汇总 | 36   | 总计 |
    ```
    
- **数据保存**：保存在 `.md` 文件，支持 Sync。

### 5. 技术要求

- **环境**：Obsidian 0.15.0 及以上。
- **依赖**：Node.js、TypeScript、HTML Reader 插件。
- **开发工具**：VS Code、npm。

### 6. 验收标准

- 嵌入 HTML 页面正常显示并可交互。
- 用户输入数据后，点击“保存到笔记”按钮，Markdown 表格正确生成。
- 金额汇总行准确计算，数据保存到笔记中。
- 支持多行编辑和数据同步。

### 7. 后续扩展

- 实时更新表格。
- 支持多语言标题。
- 添加数据验证和错误提示。