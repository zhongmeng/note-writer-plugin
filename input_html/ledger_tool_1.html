<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Obsidian 账本工具</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      background-color: #f0f0f0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f4f4f4;
      font-weight: bold;
    }
    input, select {
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input[type="number"] {
      width: 100px;
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .delete-btn {
      background-color: #f44336;
    }
    .delete-btn:hover {
      background-color: #d32f2f;
    }
    .input-row-table {
      background-color: #f8f9fa;
      border: 2px solid #007bff;
    }
    .input-row-table td {
      padding: 5px;
    }
    .input-row-table input, .input-row-table select {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px;
      font-size: 14px;
    }

    .btn {
      border: none;
      padding: 3px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      margin: 1px;
      min-width: 35px;
      transition: all 0.2s;
    }
    .add-btn {
      background-color: #007bff;
      color: white;
    }
    .add-btn:hover {
      background-color: #0056b3;
    }
    .edit-btn {
      background-color: #28a745;
      color: white;
    }
    .edit-btn:hover {
      background-color: #218838;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
    .save-btn {
      background-color: #17a2b8;
      color: white;
    }
    .save-btn:hover {
      background-color: #138496;
    }
    .cancel-btn {
      background-color: #6c757d;
      color: white;
    }
    .cancel-btn:hover {
      background-color: #5a6268;
    }
    .operation-cell {
      white-space: nowrap;
      min-width: 105px;
      text-align: center;
    }
    .total-row {
      font-weight: bold;
      background-color: #e0f7fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>账本工具</h2>
    <div style="margin-bottom: 10px;">
      <button onclick="sendToObsidian()">写入到笔记</button>
      <button onclick="loadFromObsidian()">读取笔记数据</button>
      <button onclick="showTemplate()">查看模板</button>
    </div>
    <table id="ledgerTable">
      <thead>
        <tr>
          <th>序号</th>
          <th>描述</th>
          <th>时间</th>
          <th>类别</th>
          <th>收支类型</th>
          <th>金额</th>
          <th>备注</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="ledgerBody">
        <!-- 输入行 -->
        <tr class="input-row-table">
          <td><span id="nextSequence">1</span></td>
          <td><input type="text" id="descInput" placeholder="描述" required></td>
          <td><input type="text" id="timeInput" placeholder="时间"></td>
          <td>
            <select id="categoryInput">
              <option value="">选择类别</option>
              <option value="房租">房租</option>
              <option value="缴水费">缴水费</option>
              <option value="缴电费">缴电费</option>
              <option value="维修">维修</option>
              <option value="其他">其他</option>
            </select>
          </td>
          <td><span id="incomeType">支出</span></td>
          <td><input type="number" id="amountInput" placeholder="金额" step="0.01" required></td>
          <td><input type="text" id="remarksInput" placeholder="备注"></td>
          <td class="operation-cell"><button onclick="addEntry()" class="btn add-btn">加</button></td>
        </tr>
      </tbody>
      <tfoot>
        <tr class="total-row">
          <td colspan="5">总计</td>
          <td id="totalAmount">0.00</td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    // localStorage相关函数已移除，数据现在通过Obsidian笔记管理

    function addEntryToTable(entry) {
      const tableBody = document.getElementById('ledgerBody');
      const inputRow = document.querySelector('.input-row-table');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${entry.sequence}</td>
        <td>${entry.description}</td>
        <td>${entry.time || ''}</td>
        <td>${entry.category || ''}</td>
        <td>${entry.incomeType}</td>
        <td>${parseFloat(entry.amount).toFixed(2)}</td>
        <td>${entry.remarks || ''}</td>
        <td class="operation-cell">
          <button class="btn add-btn" onclick="addRowAfter(this)">加</button>
          <button class="btn edit-btn" onclick="editEntry(this)">改</button>
          <button class="btn delete-btn" onclick="deleteEntry(this)">删</button>
        </td>
      `;
      // 将新行插入到输入行之后
      tableBody.insertBefore(row, inputRow.nextSibling);
    }

    function addEntry() {
      const descInput = document.getElementById('descInput');
      const timeInput = document.getElementById('timeInput');
      const amountInput = document.getElementById('amountInput');
      const categoryInput = document.getElementById('categoryInput');
      const remarksInput = document.getElementById('remarksInput');

      if (!descInput.value || !amountInput.value) {
        alert('请填写必需字段：描述、金额！');
        return;
      }

      const amount = parseFloat(amountInput.value);
      const incomeType = amount >= 0 ? '收入' : '支出';
      const sequence = getNextSequence();

      const entry = {
        sequence: sequence,
        description: descInput.value,
        time: timeInput.value,
        category: categoryInput.value,
        incomeType: incomeType,
        amount: amount,
        remarks: remarksInput.value
      };

      addEntryToTable(entry);
      updateTotal();
      updateNextSequence();

      // 清空输入框
      descInput.value = '';
      timeInput.value = '';
      amountInput.value = '';
      remarksInput.value = '';
      
      // 重置收支类型显示
      updateIncomeTypeDisplay();
    }

    function deleteEntry(button) {
      button.parentElement.parentElement.remove();
      updateTotal();
      updateNextSequence();
      updateSequenceNumbers();
    }

    // 在指定行后添加新行
    function addRowAfter(button) {
      const currentRow = button.parentElement.parentElement;
      const newRow = document.createElement('tr');
      const nextSeq = getMaxSequence() + 1;
      
      newRow.innerHTML = `
        <td>${nextSeq}</td>
        <td><input type="text" placeholder="描述" required></td>
        <td><input type="text" placeholder="时间"></td>
        <td>
          <select>
            <option value="">选择类别</option>
            <option value="房租">房租</option>
            <option value="缴水费">缴水费</option>
            <option value="缴电费">缴电费</option>
            <option value="维修">维修</option>
            <option value="其他">其他</option>
          </select>
        </td>
        <td>支出</td>
        <td><input type="number" placeholder="金额" step="0.01" required></td>
        <td><input type="text" placeholder="备注"></td>
        <td class="operation-cell">
          <button class="btn save-btn" onclick="saveNewRow(this)">存</button>
          <button class="btn cancel-btn" onclick="cancelNewRow(this)">消</button>
        </td>
      `;
      
      // 插入到当前行之后
      currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
    }

    // 保存新行
    function saveNewRow(button) {
      const row = button.parentElement.parentElement;
      const inputs = row.querySelectorAll('input, select');
      
      const description = inputs[0].value;
      const time = inputs[1].value;
      const category = inputs[2].value;
      const amount = parseFloat(inputs[3].value);
      const remarks = inputs[4].value;
      
      if (!description || !amount) {
        alert('请填写必需字段：描述、金额！');
        return;
      }
      
      const sequence = row.cells[0].textContent;
      const incomeType = amount >= 0 ? '收入' : '支出';
      
      // 替换为数据行
      row.innerHTML = `
        <td>${sequence}</td>
        <td>${description}</td>
        <td>${time || ''}</td>
        <td>${category || ''}</td>
        <td>${incomeType}</td>
        <td>${amount.toFixed(2)}</td>
        <td>${remarks || ''}</td>
        <td class="operation-cell">
          <button class="btn add-btn" onclick="addRowAfter(this)">加</button>
          <button class="btn edit-btn" onclick="editEntry(this)">改</button>
          <button class="btn delete-btn" onclick="deleteEntry(this)">删</button>
        </td>
      `;
      
      updateTotal();
      updateNextSequence();
    }

    // 取消新行
    function cancelNewRow(button) {
      button.parentElement.parentElement.remove();
    }

    // 获取最大序号
    function getMaxSequence() {
      const rows = document.querySelectorAll('#ledgerBody tr:not(.input-row-table)');
      let maxSeq = 0;
      rows.forEach(row => {
        const seq = parseInt(row.cells[0].textContent) || 0;
        if (seq > maxSeq) maxSeq = seq;
      });
      return maxSeq;
    }

    // 更新所有行的序号
    function updateSequenceNumbers() {
      const rows = document.querySelectorAll('#ledgerBody tr:not(.input-row-table)');
      rows.forEach((row, index) => {
        row.cells[0].textContent = index + 1;
      });
    }

    // 编辑条目
    function editEntry(button) {
      const row = button.parentElement.parentElement;
      const cells = row.cells;
      
      // 保存原始数据
      const originalData = {
        sequence: cells[0].textContent,
        description: cells[1].textContent,
        time: cells[2].textContent,
        category: cells[3].textContent,
        incomeType: cells[4].textContent,
        amount: cells[5].textContent,
        remarks: cells[6].textContent
      };
      
      // 转换为编辑模式
      row.innerHTML = `
        <td>${originalData.sequence}</td>
        <td><input type="text" value="${originalData.description}" required></td>
        <td><input type="text" value="${originalData.time}"></td>
        <td>
          <select>
            <option value="">选择类别</option>
            <option value="房租" ${originalData.category === '房租' ? 'selected' : ''}>房租</option>
            <option value="缴水费" ${originalData.category === '缴水费' ? 'selected' : ''}>缴水费</option>
            <option value="缴电费" ${originalData.category === '缴电费' ? 'selected' : ''}>缴电费</option>
            <option value="维修" ${originalData.category === '维修' ? 'selected' : ''}>维修</option>
            <option value="其他" ${originalData.category === '其他' ? 'selected' : ''}>其他</option>
          </select>
        </td>
        <td>${originalData.incomeType}</td>
        <td><input type="number" value="${originalData.amount}" step="0.01" required></td>
        <td><input type="text" value="${originalData.remarks}"></td>
        <td class="operation-cell">
          <button class="btn save-btn" onclick="saveEdit(this)">存</button>
          <button class="btn cancel-btn" onclick="cancelEdit(this, ${JSON.stringify(originalData).replace(/"/g, '&quot;')})">消</button>
        </td>
      `;
    }

    // 保存编辑
    function saveEdit(button) {
      const row = button.parentElement.parentElement;
      const inputs = row.querySelectorAll('input, select');
      
      const description = inputs[0].value;
      const time = inputs[1].value;
      const category = inputs[2].value;
      const amount = parseFloat(inputs[3].value);
      const remarks = inputs[4].value;
      
      if (!description || !amount) {
        alert('请填写必需字段：描述、金额！');
        return;
      }
      
      const sequence = row.cells[0].textContent;
      const incomeType = amount >= 0 ? '收入' : '支出';
      
      // 替换为数据行
      row.innerHTML = `
        <td>${sequence}</td>
        <td>${description}</td>
        <td>${time || ''}</td>
        <td>${category || ''}</td>
        <td>${incomeType}</td>
        <td>${amount.toFixed(2)}</td>
        <td>${remarks || ''}</td>
        <td class="operation-cell">
          <button class="btn add-btn" onclick="addRowAfter(this)">加</button>
          <button class="btn edit-btn" onclick="editEntry(this)">改</button>
          <button class="btn delete-btn" onclick="deleteEntry(this)">删</button>
        </td>
      `;
      
      updateTotal();
    }

    // 取消编辑
    function cancelEdit(button, originalDataStr) {
      const row = button.parentElement.parentElement;
      const originalData = JSON.parse(originalDataStr.replace(/&quot;/g, '"'));
      
      // 恢复原始数据
      row.innerHTML = `
        <td>${originalData.sequence}</td>
        <td>${originalData.description}</td>
        <td>${originalData.time}</td>
        <td>${originalData.category}</td>
        <td>${originalData.incomeType}</td>
        <td>${originalData.amount}</td>
        <td>${originalData.remarks}</td>
        <td class="operation-cell">
          <button class="btn add-btn" onclick="addRowAfter(this)">加</button>
          <button class="btn edit-btn" onclick="editEntry(this)">改</button>
          <button class="btn delete-btn" onclick="deleteEntry(this)">删</button>
        </td>
      `;
    }

    function updateTotal() {
      const rows = document.querySelectorAll('#ledgerBody tr:not(.input-row-table)');
      let total = 0;
      rows.forEach(row => {
        total += parseFloat(row.cells[5].textContent) || 0; // 金额现在在第6列（索引5）
      });
      document.getElementById('totalAmount').textContent = total.toFixed(2);
    }

    // 获取下一个序号
    function getNextSequence() {
      const rows = document.querySelectorAll('#ledgerBody tr:not(.input-row-table)');
      return rows.length + 1;
    }

    // 更新下一个序号显示
    function updateNextSequence() {
      const nextSeq = getNextSequence();
      document.getElementById('nextSequence').textContent = nextSeq;
    }

    // 根据金额自动更新收支类型显示
    function updateIncomeTypeDisplay() {
      const amountInput = document.getElementById('amountInput');
      const incomeTypeSpan = document.getElementById('incomeType');
      
      amountInput.addEventListener('input', function() {
        const amount = parseFloat(this.value);
        if (isNaN(amount)) {
          incomeTypeSpan.textContent = '支出';
        } else if (amount >= 0) {
          incomeTypeSpan.textContent = '收入';
        } else {
          incomeTypeSpan.textContent = '支出';
        }
      });
    }

    // 监听Enter键
    document.getElementById('amountInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addEntry();
    });

    // 模板配置
    const TABLE_TEMPLATE = {
      title: '收支记录',
      headers: ['序号', '描述', '时间', '类别', '收支类型', '金额', '备注']
    };

    // 查看模板
    function showTemplate() {
      const templateInfo = `
表格模板信息：
- 标题：${TABLE_TEMPLATE.title}
- 列头：${TABLE_TEMPLATE.headers.join(' | ')}
- 格式：Markdown 表格

示例输出：
## ${TABLE_TEMPLATE.title}

| ${TABLE_TEMPLATE.headers.join(' | ')} |
|${TABLE_TEMPLATE.headers.map(() => '------').join('|')}|
| 1 | 示例描述 | 2025-01-15 | 房租 | 支出 | -1000.00 | 示例备注 |
| **总计** | | | | | **-1000.00** | |
      `;
      alert(templateInfo);
    }

    // 页面加载时初始化
    window.addEventListener('load', function() {
      updateIncomeTypeDisplay();
    });

    // 发送数据到 Obsidian 的函数
    function sendToObsidian() {
      const rows = Array.from(document.querySelectorAll('#ledgerBody tr:not(.input-row-table)'));
      const expenses = rows.map(row => ({
        sequence: row.cells[0].textContent,
        description: row.cells[1].textContent,
        time: row.cells[2].textContent,
        category: row.cells[3].textContent,
        incomeType: row.cells[4].textContent,
        amount: parseFloat(row.cells[5].textContent),
        remarks: row.cells[6].textContent
      }));

      if (window.parent) {
        window.parent.postMessage({
          type: 'write-to-note',
          payload: { 
            expenses,
            template: TABLE_TEMPLATE
          }
        }, '*');
      } else {
        alert('无法发送数据到 Obsidian，请确保嵌入在 iframe 中！');
      }
    }

    // 从 Obsidian 读取数据的函数
    function loadFromObsidian() {
      if (window.parent) {
        window.parent.postMessage({
          type: 'read-from-note'
        }, '*');
      } else {
        alert('无法从 Obsidian 读取数据，请确保嵌入在 iframe 中！');
      }
    }

    // 监听来自 Obsidian 的消息
    window.addEventListener('message', (event) => {
      if (event.data.type === 'note-data-response') {
        const expenses = event.data.payload.expenses || [];
        // 清空现有数据行，保留输入行
        const dataRows = document.querySelectorAll('#ledgerBody tr:not(.input-row-table)');
        dataRows.forEach(row => row.remove());
        // 加载数据到表格
        expenses.forEach(entry => addEntryToTable(entry));
        updateTotal();
        updateNextSequence();
      }
    });
  </script>
</body>
</html>